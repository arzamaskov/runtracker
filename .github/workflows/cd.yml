name: CD

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0 or latest)'
        required: false
        default: 'latest'
        type: string
  workflow_run:
    workflows: ["Build Images"]
    types:
      - completed

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only run if Build Images succeeded (for workflow_run trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: production
      url: https://runtracker.ru

    steps:
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.2.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 15m
          envs: GITHUB_TOKEN
          script: |
            set -euo pipefail

            REPO_URL="https://github.com/arzamaskov/runtracker.git"
            DEPLOY_DIR="/opt/run-app"

            # Backup app.env if exists
            if [ -f "$DEPLOY_DIR/app.env" ]; then
              echo "Backing up app.env..."
              cp "$DEPLOY_DIR/app.env" /tmp/app.env.backup
            fi

            # Clone or pull repository
            if [ -d "$DEPLOY_DIR/.git" ]; then
              echo "Updating repository..."
              cd "$DEPLOY_DIR"
              git fetch origin main
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              git clone --depth 1 "$REPO_URL" "$DEPLOY_DIR"
              cd "$DEPLOY_DIR"
            fi

            # Restore app.env
            if [ -f "/tmp/app.env.backup" ]; then
              echo "Restoring app.env..."
              cp /tmp/app.env.backup "$DEPLOY_DIR/app.env"
              rm /tmp/app.env.backup
            fi

            # Determine version to deploy
            # For workflow_dispatch: use input version
            # For workflow_run (after Build Images): use the tag from the triggering workflow
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              VERSION="${{ github.event.workflow_run.head_branch }}"
            fi

            if [ "$VERSION" = "latest" ] || [ -z "$VERSION" ]; then
              APP_TAG="app-latest"
            else
              APP_TAG="app-$VERSION"
            fi

            echo "Deploying version: $VERSION (APP_TAG=$APP_TAG)"

            # Login to GitHub Container Registry
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull and restart
            IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/runtracker" APP_TAG="$APP_TAG" docker compose -f docker-compose.production.yml pull
            IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/runtracker" APP_TAG="$APP_TAG" docker compose -f docker-compose.production.yml up -d --remove-orphans

            # Copy frontend assets from container to host for nginx
            rm -rf ./public/build && docker compose -f docker-compose.production.yml cp php-fpm:/var/www/html/public/build ./public/

            # Wait for services
            sleep 5

            # Maintenance and optimizations
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan down || true
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan migrate --force
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan optimize:clear
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan config:cache
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan route:cache
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan view:cache
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan event:cache
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan storage:link || true
            docker compose -f docker-compose.production.yml exec -T php-fpm php artisan up

            # Clean up
            docker image prune -f

            echo "Deployment completed successfully!"

      - name: Health check
        run: |
          echo "Performing health check..."
          curl -f https://runtracker.ru/health || exit 1
